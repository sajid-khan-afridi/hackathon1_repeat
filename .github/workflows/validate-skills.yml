name: Validate Claude Skills

on:
  push:
    branches: [main, develop]
    paths:
      - '.claude/skills/**'
      - 'scripts/validate-claude-skills.js'
  pull_request:
    branches: [main, develop]
    paths:
      - '.claude/skills/**'
      - 'scripts/validate-claude-skills.js'
  workflow_dispatch:

jobs:
  validate-skills:
    name: Validate Skills
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run skill validation
        run: node scripts/validate-claude-skills.js --verbose

      - name: Check for stub implementations
        run: |
          echo "Checking for TODO/FIXME markers in skill implementations..."

          STUB_COUNT=$(grep -r "TODO\|FIXME\|NOT IMPLEMENTED\|STUB" .claude/skills --include="*.js" --include="*.ts" --include="*.py" | wc -l || echo "0")

          if [ "$STUB_COUNT" -gt 0 ]; then
            echo "Warning: Found $STUB_COUNT TODO/FIXME markers in skills:"
            grep -r "TODO\|FIXME\|NOT IMPLEMENTED\|STUB" .claude/skills --include="*.js" --include="*.ts" --include="*.py" -n || true
            echo ""
            echo "Consider addressing these before merging."
          else
            echo "No stub markers found in skill implementations."
          fi

      - name: Validate skill.json schemas
        run: |
          echo "Validating skill.json files..."

          for skill_json in .claude/skills/*/skill.json; do
            skill_name=$(dirname "$skill_json" | xargs basename)
            echo "Checking: $skill_name"

            # Check required fields
            if ! node -e "
              const skill = require('./$skill_json');
              if (!skill.name) throw new Error('Missing name');
              if (!skill.description) throw new Error('Missing description');
              if (!skill.version) throw new Error('Missing version');
              console.log('  - Valid: $skill_name');
            "; then
              echo "  - Invalid: $skill_name"
              exit 1
            fi
          done

          echo "All skill.json files are valid."

  lint-skills:
    name: Lint Skill Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint JavaScript skills
        run: |
          # Check if eslint is available
          if npm list eslint >/dev/null 2>&1; then
            echo "Running ESLint on skill files..."
            npx eslint ".claude/skills/**/index.js" --ignore-pattern "node_modules" || true
          else
            echo "ESLint not configured, skipping JS lint"
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Lint Python skills
        run: |
          pip install flake8 --quiet
          echo "Running flake8 on Python skill files..."
          flake8 .claude/skills --ignore=E501,W503 --exclude=node_modules,__pycache__ || true

  test-skills:
    name: Test Skills
    runs-on: ubuntu-latest
    needs: validate-skills

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Node dependencies
        run: npm ci

      - name: Install Python dependencies
        run: |
          pip install pytest pytest-cov --quiet
          # Install skill-specific requirements
          for req_file in .claude/skills/*/requirements.txt; do
            if [ -f "$req_file" ]; then
              echo "Installing: $req_file"
              pip install -r "$req_file" --quiet || true
            fi
          done

      - name: Run Python skill tests
        run: |
          echo "Running Python skill tests..."
          for test_file in .claude/skills/*/test_*.py; do
            if [ -f "$test_file" ]; then
              skill_dir=$(dirname "$test_file")
              skill_name=$(basename "$skill_dir")
              echo "Testing: $skill_name"
              cd "$skill_dir"
              pytest "$(basename $test_file)" -v --tb=short || echo "Tests failed for $skill_name"
              cd - > /dev/null
            fi
          done
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        continue-on-error: true

      - name: Summary
        run: |
          echo "Skill validation and testing complete."
          echo ""
          echo "Skills directory structure:"
          find .claude/skills -maxdepth 2 -type f \( -name "*.json" -o -name "*.md" -o -name "index.*" \) | sort
